services:
  # ---------------------------------------------------------------------------
  # MongoDB 8.0 – single-node replica set (needed for change streams)
  # ---------------------------------------------------------------------------
  mongodb:
    image: mongo:8.0
    container_name: mcp-mongodb
    command: ["mongod", "--replSet", "rs0", "--bind_ip_all"]
    ports:
      - "27017:27017"
    volumes:
      - mongo-data:/data/db
    healthcheck:
      test: >
        mongosh --quiet --eval "
          try { rs.status().ok } catch(e) {
            rs.initiate({ _id: 'rs0', members: [{ _id: 0, host: 'mongodb:27017' }] });
            1;
          }
        "
      interval: 5s
      timeout: 10s
      retries: 10
      start_period: 10s
    networks:
      - workshop

  # ---------------------------------------------------------------------------
  # One-shot seed container – loads POS data into MongoDB
  # ---------------------------------------------------------------------------
  mongo-seed:
    image: mongo:8.0
    container_name: mcp-seed
    depends_on:
      mongodb:
        condition: service_healthy
    volumes:
      - ./seed:/seed
    entrypoint: ["bash", "/seed/seed.sh"]
    environment:
      MONGODB_URI: ${MONGODB_URI:-mongodb://mongodb:27017/pos?replicaSet=rs0}
    networks:
      - workshop

  # ---------------------------------------------------------------------------
  # MongoDB MCP Server – HTTP / Streamable-HTTP transport
  # ---------------------------------------------------------------------------
  mcp-server:
    image: mongodb/mongodb-mcp-server:latest
    container_name: mcp-server
    depends_on:
      mongodb:
        condition: service_healthy
    ports:
      - "8808:8808"
    environment:
      MDB_MCP_CONNECTION_STRING: ${MONGODB_URI:-mongodb://mongodb:27017/pos?replicaSet=rs0}
      MDB_MCP_TRANSPORT: http
      MDB_MCP_HTTP_HOST: "0.0.0.0"
      MDB_MCP_HTTP_PORT: "8808"
    healthcheck:
      test: ["CMD", "node", "-e", "fetch('http://localhost:8808/mcp').then(r => process.exit(r.ok || r.status < 500 ? 0 : 1)).catch(() => process.exit(1))"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s
    networks:
      - workshop

  # ---------------------------------------------------------------------------
  # Bedrock Access Gateway – OpenAI-compatible proxy for AWS Bedrock
  # Only starts with:  docker compose --profile bedrock up -d
  # ---------------------------------------------------------------------------
  bedrock-gateway:
    image: duaneleem/aws-bedrock-access-gateway:latest
    container_name: mcp-bedrock-gw
    profiles: ["bedrock"]
    ports:
      - "8866:8866"
    environment:
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
      AWS_DEFAULT_REGION: ${AWS_DEFAULT_REGION:-us-east-1}
      PORT: "8866"
    networks:
      - workshop

  # ---------------------------------------------------------------------------
  # mcpo – MCP-to-OpenAPI proxy (bridges MCP server → Open WebUI tools)
  # ---------------------------------------------------------------------------
  mcpo:
    image: ghcr.io/open-webui/mcpo:main
    container_name: mcp-mcpo
    depends_on:
      mcp-server:
        condition: service_healthy
    restart: on-failure
    ports:
      - "8001:8000"
    command: --server-type streamable-http -- http://mcp-server:8808/mcp
    networks:
      - workshop

  # ---------------------------------------------------------------------------
  # Open WebUI – web-based chat interface with native MCP support
  # ---------------------------------------------------------------------------
  open-webui:
    image: ghcr.io/open-webui/open-webui:main
    container_name: mcp-webui
    depends_on:
      - mcp-server
    ports:
      - "3000:8080"
    environment:
      OPENAI_API_BASE_URLS: ${OPENAI_API_BASE_URLS}
      OPENAI_API_KEYS: ${OPENAI_API_KEYS}
      WEBUI_SECRET_KEY: ${WEBUI_SECRET_KEY:-mcp-workshop-secret}
      ENABLE_SIGNUP: "true"
      DEFAULT_MODELS: ${DEFAULT_MODEL:-gpt-4o}
      ENABLE_OLLAMA_API: "false"
      RAG_TEMPLATE: >-
        ### Instructions:
        The context below contains **actual results returned by tools you called**
        (e.g. MongoDB queries, aggregations, index operations). Treat them as
        authoritative data — do NOT tell the user to run the query themselves.

        Use the tool results to directly and completely answer the user's question.
        Include specific numbers, field values, and document counts from the results.
        If the results are empty or indicate an error, explain what that means.
        Cite the source using [id] only when a <source id="..."> tag is present.

        <context>
        {{CONTEXT}}
        </context>
    volumes:
      - webui-data:/app/backend/data
    networks:
      - workshop

  # ---------------------------------------------------------------------------
  # Node.js POS API – intentionally unoptimized for workshop labs
  # ---------------------------------------------------------------------------
  node-sample:
    build:
      context: ./node-sample
      dockerfile: Dockerfile
    container_name: mcp-pos-api
    depends_on:
      mongodb:
        condition: service_healthy
    ports:
      - "4000:4000"
    environment:
      MONGODB_URI: ${MONGODB_URI:-mongodb://mongodb:27017/pos?replicaSet=rs0}
      PORT: "4000"
    networks:
      - workshop

volumes:
  mongo-data:
  webui-data:

networks:
  workshop:
    driver: bridge
